<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Desafio 40 Dias Pro</title>
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/trophy.png">
    
    <!-- Tailwind & React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #020617; /* Slate 950 */
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism Refinado */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Inputs num√©ricos sem setas */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden selection:bg-emerald-500/30">

    <div id="root" class="h-full w-full overflow-y-auto no-scrollbar relative"></div>

    <!-- Error Fallback -->
    <div id="error-display" style="display:none; color: #ef4444; padding: 20px; text-align: center; margin-top: 50px;">
        <h2>Erro Cr√≠tico</h2>
        <p id="error-message" style="font-size: 0.8rem; opacity: 0.7;"></p>
        <button onclick="localStorage.clear(); window.location.reload();" style="margin-top:20px; padding:10px; background:#333; color:#fff; border-radius:8px;">Resetar App</button>
    </div>

    <script>
        window.onerror = function(msg) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-message').innerText = msg;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (SVG NATIVO - ZERO DEPENDENCIA) ---
        const Icons = {
            Trophy: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Settings: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ChevronLeft: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Target: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Waves: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/></svg>,
            Flame: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>,
            Dumbbell: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>,
            Utensils: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
            Scale: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
            Moon: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Download: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            FileText: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Calendar: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            TrendingUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
        };

        // --- CONSTANTES ---
        const TARGETS = { protein: 230, carbs: 170, fat: 75, workoutsPerWeek: 8 };
        const WEEKLY_GOALS = { natacao: 3, crossfit: 2, musculacao: 3 };
        const QUICK_ADDS = [
            { name: '100g Frango/Carne', p: 30, c: 0, f: 5, icon: 'üçó' },
            { name: '1 Ovo Inteiro', p: 6, c: 0.5, f: 5, icon: 'ü•ö' },
            { name: '100g Arroz', p: 2.5, c: 28, f: 0.2, icon: 'üçö' },
            { name: '1 Banana', p: 1, c: 23, f: 0, icon: 'üçå' },
            { name: '1 Scoop Whey', p: 20, c: 3, f: 1, icon: 'üí™' },
            { name: '10g Azeite', p: 0, c: 0, f: 10, icon: 'ü´í' },
            { name: '100g Batata', p: 2, c: 17, f: 0, icon: 'ü•î' }
        ];

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            // Estado Principal
            const [history, setHistory] = useState([]);
            const [dailyLog, setDailyLog] = useState({
                protein: 0, carbs: 0, fat: 0, weight: '', sleepHours: '', isRestDay: false, workouts: []
            });
            const [startDate, setStartDate] = useState(null);
            
            // Estado UI
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [showSettings, setShowSettings] = useState(false);
            const fileInputRef = useRef(null);

            // Carregar Dados
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem('desafio40_data_final');
                    const savedStart = localStorage.getItem('desafio40_start_final');
                    
                    if (savedData) setHistory(JSON.parse(savedData));
                    if (savedStart) setStartDate(new Date(savedStart));
                    else {
                        const now = new Date();
                        setStartDate(now);
                        localStorage.setItem('desafio40_start_final', now.toISOString());
                    }
                } catch (e) { console.error("Erro load:", e); }
            }, []);

            // Atualizar Log Di√°rio ao mudar dia
            useEffect(() => {
                const log = history.find(h => h.date === currentDate);
                if (log) setDailyLog(log);
                else setDailyLog({
                    protein: 0, carbs: 0, fat: 0, weight: '', 
                    sleepHours: '', isRestDay: false, workouts: [], date: currentDate
                });
            }, [currentDate, history]);

            // --- L√≥gica de Salvamento ---
            const saveData = (newLog) => {
                const updatedLog = { ...newLog, date: currentDate };
                setDailyLog(updatedLog);

                let newHistory = [...history];
                const idx = newHistory.findIndex(h => h.date === currentDate);
                if (idx >= 0) newHistory[idx] = updatedLog;
                else newHistory.push(updatedLog);

                newHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                setHistory(newHistory);
                localStorage.setItem('desafio40_data_final', JSON.stringify(newHistory));
            };

            const updateField = (field, val) => saveData({ ...dailyLog, [field]: val });

            const updateMacro = (type, val, isAbsolute = false) => {
                const current = parseFloat(dailyLog[type]) || 0;
                // isAbsolute=true quando digita no input, false quando usa bot√µes
                const newValue = isAbsolute ? parseFloat(val) : Math.max(0, current + val);
                updateField(type, newValue);
            };

            const toggleWorkout = (type) => {
                if (dailyLog.isRestDay) return;
                let workouts = dailyLog.workouts || [];
                if (workouts.includes(type)) workouts = workouts.filter(w => w !== type);
                else workouts = [...workouts, type];
                saveData({ ...dailyLog, workouts });
            };

            // --- Estat√≠sticas & CSV ---
            const getDayNumber = () => {
                if (!startDate) return 1;
                const diff = new Date(currentDate) - new Date(startDate);
                return Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
            };

            const dailyScore = useMemo(() => {
                let s = 0;
                if (dailyLog.workouts?.length > 0) s += 50;
                s += Math.min(1, (dailyLog.protein || 0) / TARGETS.protein) * 50;
                return Math.round(s);
            }, [dailyLog]);

            const weeklyStats = useMemo(() => {
                const d = new Date(currentDate);
                const day = d.getDay();
                const start = new Date(d); start.setDate(d.getDate() - day); start.setHours(0,0,0,0);
                const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999);

                let stats = { natacao: 0, crossfit: 0, musculacao: 0, total: 0 };
                history.forEach(h => {
                    const hDate = new Date(h.date + 'T12:00:00');
                    if (hDate >= start && hDate <= end && h.workouts) {
                        h.workouts.forEach(w => { if(stats[w] !== undefined) stats[w]++; });
                        if(h.workouts.length > 0) stats.total++;
                    }
                });
                return stats;
            }, [history, currentDate]);

            const monthlyStats = useMemo(() => {
                const cur = new Date(currentDate);
                const curMonth = cur.getMonth();
                const totalWorkouts = history.reduce((acc, h) => {
                    const hDate = new Date(h.date + 'T12:00:00');
                    return (hDate.getMonth() === curMonth && h.workouts) ? acc + h.workouts.length : acc;
                }, 0);
                return { name: cur.toLocaleDateString('pt-BR', {month:'long'}), total: totalWorkouts, target: 32 }; // Meta 32 arbitraria mensal
            }, [history, currentDate]);

            const exportCSV = () => {
                if (history.length === 0) return alert("Sem dados.");
                const headers = "Data,Peso,Sono,Proteina,Carbo,Gordura,Treinos\n";
                const rows = history.map(h => 
                    `${h.date},${h.weight||0},${h.sleepHours||0},${h.protein},${h.carbs},${h.fat},"${(h.workouts||[]).join('+')}"`
                ).join("\n");
                
                const blob = new Blob([headers + rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute("download", `desafio_dados_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
            };

            const exportBackup = () => {
                const blob = new Blob([JSON.stringify({ history, startDate })], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_full_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const importBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.history) {
                            if (confirm('Sobrescrever tudo com este backup?')) {
                                setHistory(data.history);
                                if(data.startDate) {
                                    setStartDate(new Date(data.startDate));
                                    localStorage.setItem('desafio40_start_final', data.startDate);
                                }
                                localStorage.setItem('desafio40_data_final', JSON.stringify(data.history));
                                alert('Restaurado!');
                                window.location.reload();
                            }
                        }
                    } catch (err) { alert('Erro no arquivo'); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="pb-20 min-h-full">
                    
                    {/* Header Nav */}
                    <div className="bg-slate-900 border-b border-slate-800 sticky top-0 z-20 px-4 pt-safe pb-2 shadow-lg">
                        <div className="flex justify-between items-center mb-3">
                            <div className="flex items-center gap-2">
                                <Icons.Trophy className="text-yellow-500 w-6 h-6" />
                                <div>
                                    <h1 className="font-bold text-lg leading-none">Desafio 40</h1>
                                    <p className="text-xs text-emerald-400 font-bold uppercase">Dia {getDayNumber()}</p>
                                </div>
                            </div>
                            <button onClick={() => setShowSettings(true)} className="p-2 bg-slate-800 rounded-full text-slate-400">
                                <Icons.Settings className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="flex items-center justify-between bg-slate-800 rounded-lg p-1">
                            <button onClick={() => { const d=new Date(currentDate); d.setDate(d.getDate()-1); setCurrentDate(d.toISOString().split('T')[0]); }} className="p-2 text-slate-400"><Icons.ChevronLeft className="w-5 h-5"/></button>
                            <input type="date" value={currentDate} onChange={(e) => setCurrentDate(e.target.value)} className="bg-transparent text-center font-bold text-slate-200 outline-none" />
                            <button onClick={() => { const d=new Date(currentDate); d.setDate(d.getDate()+1); setCurrentDate(d.toISOString().split('T')[0]); }} className="p-2 text-slate-400"><Icons.ChevronRight className="w-5 h-5"/></button>
                        </div>
                    </div>

                    <main className="p-4 space-y-6 max-w-md mx-auto">
                        
                        {/* Score Card */}
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-2xl border border-slate-700 shadow-xl relative overflow-hidden">
                            <div className="flex justify-between items-end relative z-10">
                                <div>
                                    <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Score Di√°rio</p>
                                    <p className="text-4xl font-black text-white">{dailyScore}%</p>
                                </div>
                                <div className={`p-3 rounded-xl ${dailyScore>=100?'bg-emerald-500/20 text-emerald-400':'bg-slate-700/50 text-slate-500'}`}>
                                    <Icons.Target className="w-8 h-8" />
                                </div>
                            </div>
                            <div className="mt-4 h-2 bg-slate-950 rounded-full overflow-hidden relative z-10">
                                <div className={`h-full transition-all duration-700 ${dailyScore>=100?'bg-emerald-500':'bg-blue-500'}`} style={{width: `${dailyScore}%`}}></div>
                            </div>
                        </div>

                        {/* Estat√≠sticas Semana/M√™s (RESTAURADO) */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="glass p-3 rounded-xl">
                                <div className="flex items-center gap-1 mb-2 text-xs text-blue-400 font-bold uppercase"><Icons.Calendar className="w-3 h-3"/> Semana</div>
                                <div className="flex items-end gap-1">
                                    <span className="text-xl font-bold text-white">{weeklyStats.total}</span>
                                    <span className="text-xs text-slate-500 mb-1">/{TARGETS.workoutsPerWeek}</span>
                                </div>
                                <div className="w-full h-1.5 bg-slate-800 rounded-full mt-1 overflow-hidden">
                                    <div className="h-full bg-blue-500" style={{width: `${Math.min(100, (weeklyStats.total/TARGETS.workoutsPerWeek)*100)}%`}}></div>
                                </div>
                            </div>
                            <div className="glass p-3 rounded-xl">
                                <div className="flex items-center gap-1 mb-2 text-xs text-purple-400 font-bold uppercase"><Icons.Calendar className="w-3 h-3"/> {monthlyStats.name}</div>
                                <div className="flex items-end gap-1">
                                    <span className="text-xl font-bold text-white">{monthlyStats.total}</span>
                                    <span className="text-xs text-slate-500 mb-1">/{monthlyStats.target}</span>
                                </div>
                                <div className="w-full h-1.5 bg-slate-800 rounded-full mt-1 overflow-hidden">
                                    <div className="h-full bg-purple-500" style={{width: `${Math.min(100, (monthlyStats.total/monthlyStats.target)*100)}%`}}></div>
                                </div>
                            </div>
                        </div>

                        {/* Gr√°fico de Peso (RESTAURADO) */}
                        <div className="glass rounded-xl p-4">
                            <h3 className="text-xs font-bold text-slate-400 mb-3 uppercase flex items-center gap-2">
                                <Icons.TrendingUp className="w-4 h-4 text-emerald-400"/> Evolu√ß√£o Peso
                            </h3>
                            <WeightChart history={history} />
                        </div>

                        {/* Peso & Sono (INPUT EDITAVEL) */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center">
                                <label className="text-xs text-slate-400 mb-1 flex items-center gap-1"><Icons.Scale className="w-3 h-3"/> Peso (kg)</label>
                                <input type="number" value={dailyLog.weight} onChange={(e) => updateField('weight', e.target.value)} 
                                    className="bg-transparent text-xl font-bold text-white text-center w-full outline-none" placeholder="00.0" />
                            </div>
                            <div className="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center">
                                <label className="text-xs text-slate-400 mb-1 flex items-center gap-1"><Icons.Moon className="w-3 h-3"/> Sono (h)</label>
                                <input type="number" value={dailyLog.sleepHours} onChange={(e) => updateField('sleepHours', e.target.value)} 
                                    className="bg-transparent text-xl font-bold text-white text-center w-full outline-none" placeholder="0" />
                            </div>
                        </div>

                        {/* Treinos */}
                        <section>
                            <div className="flex justify-between items-center mb-2 px-1">
                                <h3 className="text-sm font-bold text-slate-300 flex items-center gap-2"><Icons.Dumbbell className="w-4 h-4 text-purple-400"/> Treinos</h3>
                                <button onClick={() => updateField('isRestDay', !dailyLog.isRestDay)} 
                                    className={`text-[10px] px-2 py-1 rounded border transition-colors ${dailyLog.isRestDay ? 'bg-emerald-900/30 border-emerald-700 text-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>
                                    {dailyLog.isRestDay ? 'Descanso Ativo' : 'Marcar Descanso'}
                                </button>
                            </div>
                            <div className={`grid grid-cols-3 gap-3 transition-opacity ${dailyLog.isRestDay ? 'opacity-50 pointer-events-none' : ''}`}>
                                <WorkoutCard title="Nata√ß√£o" Icon={Icons.Waves} current={weeklyStats.natacao} target={WEEKLY_GOALS.natacao} active={dailyLog.workouts?.includes('natacao')} onClick={() => toggleWorkout('natacao')} color="cyan" />
                                <WorkoutCard title="CrossFit" Icon={Icons.Flame} current={weeklyStats.crossfit} target={WEEKLY_GOALS.crossfit} active={dailyLog.workouts?.includes('crossfit')} onClick={() => toggleWorkout('crossfit')} color="orange" />
                                <WorkoutCard title="Muscula√ß√£o" Icon={Icons.Dumbbell} current={weeklyStats.musculacao} target={WEEKLY_GOALS.musculacao} active={dailyLog.workouts?.includes('musculacao')} onClick={() => toggleWorkout('musculacao')} color="purple" />
                            </div>
                        </section>

                        {/* Macros (COM INPUT EDIT√ÅVEL) */}
                        <section className="glass p-4 rounded-xl">
                            <h3 className="text-sm font-bold text-slate-200 mb-4 flex items-center gap-2"><Icons.Utensils className="w-4 h-4 text-rose-400"/> Macros</h3>
                            <div className="space-y-6">
                                <MacroRow label="Prote√≠na" type="protein" val={dailyLog.protein} target={TARGETS.protein} color="bg-emerald-500" text="text-emerald-400" update={updateMacro} />
                                <MacroRow label="Carboidrato" type="carbs" val={dailyLog.carbs} target={TARGETS.carbs} color="bg-blue-500" text="text-blue-400" update={updateMacro} />
                                <MacroRow label="Gordura" type="fat" val={dailyLog.fat} target={TARGETS.fat} color="bg-yellow-500" text="text-yellow-400" update={updateMacro} />
                            </div>
                        </section>

                        {/* Adi√ß√£o R√°pida (COM GORDURA VIS√çVEL) */}
                        <section>
                            <h3 className="text-xs font-bold text-slate-500 uppercase mb-2 px-1">Adi√ß√£o R√°pida</h3>
                            <div className="grid grid-cols-2 gap-2">
                                {QUICK_ADDS.map((item, i) => (
                                    <button key={i} onClick={() => {
                                        saveData({
                                            ...dailyLog,
                                            protein: (dailyLog.protein||0) + item.p,
                                            carbs: (dailyLog.carbs||0) + item.c,
                                            fat: (dailyLog.fat||0) + item.f
                                        });
                                    }} className="bg-slate-800 border border-slate-700/50 hover:bg-slate-700 p-3 rounded-xl flex items-center gap-3 text-left transition-colors">
                                        <span className="text-xl">{item.icon}</span>
                                        <div>
                                            <p className="text-xs font-bold text-slate-200">{item.name}</p>
                                            <div className="text-[10px] text-slate-400 flex gap-2 mt-0.5">
                                                {item.p > 0 && <span className="text-emerald-400">P:{item.p}</span>}
                                                {item.c > 0 && <span className="text-blue-400">C:{item.c}</span>}
                                                {item.f > 0 && <span className="text-yellow-400">F:{item.f}</span>}
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </section>

                    </main>

                    {/* Settings Modal (COM CSV) */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-4" onClick={() => setShowSettings(false)}>
                            <div className="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-3xl p-6 relative" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-bold mb-6 text-white">Configura√ß√µes</h2>
                                <div className="space-y-3">
                                    <div className="bg-slate-800 p-4 rounded-xl">
                                        <p className="text-xs text-slate-400 mb-3">Gerenciamento de Dados</p>
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <button onClick={exportBackup} className="bg-slate-700 p-2 rounded text-xs font-bold flex items-center justify-center gap-2"><Icons.Download className="w-3 h-3"/> Backup JSON</button>
                                            <label className="bg-emerald-700 p-2 rounded text-xs font-bold flex items-center justify-center gap-2 cursor-pointer"><Icons.Upload className="w-3 h-3"/> Restaurar<input ref={fileInputRef} type="file" accept=".json" className="hidden" onChange={importBackup} /></label>
                                        </div>
                                        <button onClick={exportCSV} className="w-full bg-blue-900/50 text-blue-200 border border-blue-800 p-2 rounded text-xs font-bold flex items-center justify-center gap-2"><Icons.FileText className="w-3 h-3"/> Baixar Planilha Excel (CSV)</button>
                                    </div>
                                    <button onClick={() => { if(confirm("Resetar TUDO?")) { localStorage.clear(); window.location.reload(); } }} className="w-full p-3 text-red-500 text-xs font-bold">Resetar App</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- SUBCOMPONENTES ---

        function WeightChart({ history }) {
            // L√≥gica robusta para evitar erros em dados vazios
            const data = history.filter(h => h.weight && !isNaN(parseFloat(h.weight))).map(h => parseFloat(h.weight)).reverse(); // Mostrar mais recentes no fim
            if (data.length < 2) return <div className="h-20 flex items-center justify-center text-xs text-slate-600 italic">Registre peso por 2 dias para ver o gr√°fico</div>;
            
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - ((val - min) / range) * 100;
                return `${x},${y}`;
            }).join(" ");

            return (
                <div className="h-24 w-full flex items-end relative pt-2">
                    <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 100 100">
                        {/* Linha do gr√°fico */}
                        <polyline points={points} fill="none" stroke="#10b981" strokeWidth="2" vectorEffect="non-scaling-stroke" />
                        {/* Pontos */}
                        {data.map((val, i) => (
                            <circle key={i} cx={(i/(data.length-1))*100} cy={100 - ((val-min)/range)*100} r="3" fill="#0f172a" stroke="#10b981" strokeWidth="2" vectorEffect="non-scaling-stroke" />
                        ))}
                    </svg>
                    {/* Labels Min/Max */}
                    <span className="absolute bottom-0 left-0 text-[10px] text-slate-500">{min}kg</span>
                    <span className="absolute top-0 right-0 text-[10px] text-slate-500">{max}kg</span>
                </div>
            );
        }

        function MacroRow({ label, type, val, target, color, text, update }) {
            const pct = Math.min(100, (val/target)*100);
            return (
                <div>
                    <div className="flex justify-between items-end mb-2">
                        <span className="text-xs font-bold text-slate-300">{label}</span>
                        <div className="flex items-center gap-1">
                            {/* INPUT MANUAL EDIT√ÅVEL */}
                            <input 
                                type="number" 
                                value={val === 0 ? '' : val} 
                                onChange={(e) => update(type, e.target.value, true)} 
                                className={`bg-transparent text-right font-mono font-bold w-12 outline-none border-b border-dashed border-slate-700 focus:border-${color.split('-')[1]}-500 ${text}`}
                                placeholder="0"
                            />
                            <span className="text-xs text-slate-500 font-mono">/{target}g</span>
                        </div>
                    </div>
                    {/* Barra Progresso */}
                    <div className="h-2 bg-slate-900 rounded-full overflow-hidden mb-2 border border-slate-700/50">
                        <div className={`h-full ${color} transition-all duration-500`} style={{width: `${pct}%`}}></div>
                    </div>
                    {/* Bot√µes Controle */}
                    <div className="flex justify-end gap-2">
                        <button onClick={() => update(type, -10)} className="h-6 px-2 bg-slate-800 rounded border border-slate-700 text-[10px] text-slate-400 hover:bg-red-900/20 hover:text-red-400 transition-colors">-10</button>
                        <button onClick={() => update(type, 10)} className="h-6 px-3 bg-slate-800 rounded border border-slate-600 text-[10px] text-white font-bold hover:bg-slate-700 transition-colors">+10</button>
                        <button onClick={() => update(type, 30)} className="h-6 px-3 bg-slate-800 rounded border border-slate-600 text-[10px] text-white font-bold hover:bg-slate-700 transition-colors">+30</button>
                    </div>
                </div>
            );
        }

        function WorkoutCard({ title, Icon, current, target, active, onClick, color }) {
            const colors = {
                cyan: { text: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'border-cyan-500/50', bar: 'bg-cyan-500' },
                orange: { text: 'text-orange-400', bg: 'bg-orange-500/10', border: 'border-orange-500/50', bar: 'bg-orange-500' },
                purple: { text: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/50', bar: 'bg-purple-500' }
            };
            const theme = colors[color];
            const pct = Math.min(100, (current/target)*100);

            return (
                <button onClick={onClick} className={`relative p-3 rounded-xl border flex flex-col items-center justify-between min-h-[100px] transition-all active:scale-95 ${active ? `${theme.bg} ${theme.border}` : 'bg-slate-800 border-slate-700'}`}>
                    <div className={`p-1.5 rounded-full mb-1 ${active ? 'bg-white/10 text-white' : 'bg-slate-700/50 text-slate-400'}`}>
                        <Icon className={`w-4 h-4 ${active ? theme.text : ''}`} />
                    </div>
                    <div className="text-center w-full z-10">
                        <span className={`text-[10px] font-bold block uppercase tracking-wide ${active ? 'text-white' : 'text-slate-400'}`}>{title}</span>
                        <span className="text-[10px] text-slate-500 font-mono">{current}/{target}</span>
                    </div>
                    <div className="w-full h-1 bg-black/30 rounded-full mt-2 overflow-hidden">
                        <div className={`h-full transition-all ${active ? theme.bar : 'bg-slate-600'}`} style={{width: `${pct}%`}}></div>
                    </div>
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

